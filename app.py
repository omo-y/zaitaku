import streamlit as st
import openai

openai.api_key = st.secrets.OpenAIAPI1.openai_api_new_key

system_prompt = """
ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®å…¨ã¦ã®è³ªå•ã«å¯¾ã—ã¦ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å³æ ¼ã«å¾“ã£ã¦ç­”ãˆã¦ãã ã•ã„ã€‚
1. ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã®å¤§ã‚¢ãƒ«ã‚«ãƒŠã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã¦ãã ã•ã„
2. ã•ã‚‰ã«ã€æ­£ä½ç½®ã¨é€†ä½ç½®ã‚‚ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã¦ãã ã•ã„ã€‚ 
3. è³ªå•ã«å¯¾ã—ã¦ã€1 ã¨ 2 ã§ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸå†…å®¹ã‚’è¸ã¾ãˆã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚
"""

if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content": system_prompt}
        ]

def communicate():
    messages = st.session_state["messages"]

    user_message = {"role": "user", "content": st.session_state["user_input"]}
    messages.append(user_message)

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=messages
    )  

    bot_message = response["choices"][0]["message"]
    messages.append(bot_message)

    st.session_state["user_input"] = ""



st.title(" ã‚³ãƒ”ãƒ¼ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°")
st.image("06_fortunetelling.png")
st.write(f"å‰ææ¡ä»¶ã¯ä»¥ä¸‹ã€
         {system_prompt}")
st.write("å‰æã«å¾“ã„åœ¨å®…ãƒ¯ãƒ¼ã‚¯ã«ã¤ã„ã¦AIãŒã‚³ãƒ”ãƒ¼ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚")

user_input = st.text_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", key="user_input", on_change=communicate)

if st.session_state["messages"]:
    messages = st.session_state["messages"]

    for message in reversed(messages[1:]):  # ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸Šã«
        speaker = "ğŸ™‚"
        if message["role"]=="assistant":
            speaker="ğŸ¤–"

        st.write(speaker + ": " + message["content"])
